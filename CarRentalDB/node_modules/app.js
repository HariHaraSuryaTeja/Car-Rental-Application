var express = require('express');
var mysql = require('mysql');
var bodyparser = require('body-parser');

//connection
var con = mysql.createConnection({
	host : 'localhost',
	user : 'root',
	password : '',
	database : 'car-rental-application'
});

// initialise express
var app = express();
app.use(bodyparser.json());
app.use(bodyparser.urlencoded({extended:true}));


app.post('/register/',(req,res,next)=>{

	var data = req.body;
	var id = data.id;
	var phone = data.phone;
	var name = data.name;
	var password = data.password;
	var email = data.email;

	//Selicting tables from Database
	con.query( 'SELECT * FROM user where email=?' ,[email], function(err,result,fields){
			con.on('error',(err)=>{
				//gives error
				console.log('[MySQL ERROR]',err);
			});

			if(result && result.length){
				res.json('User exists !!!');
			}
			else
			{
				//Inserts values into Database
				var sql = "INSERT INTO user (id,name,phone,email, password) VALUES (?,?,?,?,?)";
				var values = [id,name,phone,email,password];

				console.log(sql,values)

				con.query(sql, values ,function(err,result,fields){
					con.on('error',(err)=>{
						console.log('[MySQL ERROR]',err)
					});
					res.json('Register Successful')
					console.log('registered')
				});
			}
		});
});

app.post('/login/',(req,res,next)=>{
	var data = req.body;
	
	var password = data.password;
	var email = data.email;


	con.query('SELECT * FROM user where email = ?',[email],function(err,result,fields){
		con.on('error',(err)=>{
			console.log('[MySQL ERROR]',err);
		});
		
		if(result && result.length){


			// result = [ RowDataPacket { id: 1, email: 'abc@abc.com', password: 'pass' } ]

			if(password == result[0].password){
				res.json('Valid user');	
			}else{
				res.json('Invalid user');
			}
		}
	});


});

// start node server
app.listen(3306,() => {
	console.log('server running on : http://localhost:%s',3306);
});